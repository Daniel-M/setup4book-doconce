<!--
Automatically generated HTML file from DocOnce source
(https://github.com/hplgit/doconce/)
-->
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="DocOnce: https://github.com/hplgit/doconce/" />
<meta name="description" content="Use of Mako to aid book writing">
<meta name="keywords" content="variables in mako,mako variables,if tests in mako,boolean in mako,mako if tests,mako boolean,functions in mako,mako functions">

<title>Use of Mako to aid book writing</title>

<!-- Bootstrap style: bootstrap_bluegray -->
<link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.rawgit.com/hplgit/doconce/master/bundled/html_styles/style_bootstrap/css/bootstrap_bluegray.css" rel="stylesheet">
<!-- not necessary
<link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
-->


</head>

<!-- tocinfo
{'highest level': 1,
 'sections': [('Use of variables', 1, None, '___sec0'),
              ("How to speak about ``this chapter''", 2, None, '___sec1'),
              ('How to make several variants of the text',
               1,
               None,
               '___sec2'),
              ("Mako's Python functions", 1, None, '___sec3'),
              ('Basics of Mako functions', 2, None, '___sec4'),
              ('How to automatically generate a DocOnce file with repetitive structure',
               2,
               'mako:pyscripts',
               'mako:pyscripts'),
              ('How to treat multiple programming languages in the same text',
               2,
               None,
               '___sec6'),
              ('Another example', 3, None, '___sec7'),
              ('References', 1, None, '___sec8')]}
end of tocinfo -->

<body>

    
<!-- Bootstrap navigation bar -->
<div class="navbar navbar-default navbar-fixed-top">
  <div class="navbar-header">
    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-responsive-collapse">
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
      <span class="icon-bar"></span>
    </button>
    <a class="navbar-brand" href="mako-bootstrap.html">Use of Mako to aid book writing</a>
  </div>
  <div class="navbar-collapse collapse navbar-responsive-collapse">
    <ul class="nav navbar-nav navbar-right">
      <li class="dropdown">
        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Contents <b class="caret"></b></a>
        <ul class="dropdown-menu">
     <!-- navigation toc: --> <li><a href="._mako-bootstrap001.html#___sec0" style="font-size: 80%;"><b>Use of variables</b></a></li>
     <!-- navigation toc: --> <li><a href="._mako-bootstrap001.html#___sec1" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;How to speak about ``this chapter''</a></li>
     <!-- navigation toc: --> <li><a href="._mako-bootstrap002.html#___sec2" style="font-size: 80%;"><b>How to make several variants of the text</b></a></li>
     <!-- navigation toc: --> <li><a href="#___sec3" style="font-size: 80%;"><b>Mako's Python functions</b></a></li>
     <!-- navigation toc: --> <li><a href="#___sec4" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;Basics of Mako functions</a></li>
     <!-- navigation toc: --> <li><a href="#mako:pyscripts" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;How to automatically generate a DocOnce file with repetitive structure</a></li>
     <!-- navigation toc: --> <li><a href="#___sec6" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;How to treat multiple programming languages in the same text</a></li>
     <!-- navigation toc: --> <li><a href="#___sec7" style="font-size: 80%;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Another example</a></li>
     <!-- navigation toc: --> <li><a href="#___sec8" style="font-size: 80%;"><b>References</b></a></li>

        </ul>
      </li>
    </ul>
  </div>
</div>
</div> <!-- end of navigation bar -->

<div class="container">

<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p> <!-- add vertical space -->

<a name="part0003"></a>
<!-- !split -->

<h1 id="___sec3">Mako's Python functions </h1>

<p>
The if tests above are fine to handle larger portions of text. What if you
need to have four versions of just one word or very short text?
A Mako function, defined as a standard Python function,
is then more appropriate.

<h2 id="___sec4">Basics of Mako functions </h2>

<p>
Here is a definition of a suitable Mako function, which must be
defined inside
<code>&lt;%</code> and <code>%&gt;</code> tags, using standard Python code:

<p>

<!-- code=python (!bc pypro) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #666666">&lt;%</span>
<span style="color: #008000; font-weight: bold">def</span> <span style="color: #0000FF">chversion</span>(text_IT1413, text_IT1713b, text_general,
              text_book1, text_book2):
    <span style="color: #008000; font-weight: bold">if</span> COURSE <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;IT1713&#39;</span>:
        <span style="color: #008000; font-weight: bold">return</span> text_IT1413
    <span style="color: #008000; font-weight: bold">elif</span> COURSE <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;IT1713b&#39;</span>:
        text_IT1413b
    <span style="color: #008000; font-weight: bold">elif</span> COURSE <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;general&#39;</span>:
        <span style="color: #008000; font-weight: bold">return</span> text_general
    <span style="color: #008000; font-weight: bold">elif</span> COURSE <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;book1&#39;</span>:
        <span style="color: #008000; font-weight: bold">return</span> text_book1
    <span style="color: #008000; font-weight: bold">elif</span> COURSE <span style="color: #666666">==</span> <span style="color: #BA2121">&#39;book2&#39;</span>:
        <span style="color: #008000; font-weight: bold">return</span> text_book2
    <span style="color: #008000; font-weight: bold">else</span>:
        <span style="color: #008000; font-weight: bold">return</span> <span style="color: #BA2121">&#39;XXX WRONG value of COURSE: </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">&#39;</span> <span style="color: #666666">%</span> COURSE
<span style="color: #666666">%&gt;</span>
</pre></div>
<p>
In the running text you can call <code>chversion</code> with five arguments,
corresponding to the desired text in the five cases, and when <code>doconce format</code>
is run, the value of <code>COURSE</code> determines which of the five cases that is used.
Here is an example on DocOnce text with a function call to <code>chversion</code>:

<p>

<!-- code=doconce (!bc do) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">It is extremely important to define the term *cure* accurately.
Here we mean ${chversion(&#39;handle&#39;, &#39;handle&#39;,
&#39;resolve&#39;, &#39;treat&#39;, &#39;resolve&#39;)}.
</pre></div>
<p>
You can easily use long multi-line strings as arguments, e.g.,

<p>

<!-- code=doconce (!bc do) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">... ${chversion(&quot;&quot;&quot;
Here comes
a multi-line
string&quot;&quot;&quot;,
&#39;short string&#39;,
&#39;another short string&#39;,
<span style="color: #BA2121">&quot;&quot;&quot;</span>4th
multi-line
string&quot;&quot;&quot;,
&#39;5th string&#39;)}
...
</pre></div>
<p>
<div class="alert alert-block alert-success alert-text-normal"><b>There are two types of Mako functions.</b>
One type resembles Python functions, as demonstrated above. The other
type employs a slightly different syntax and is exemplified in the file
<a href="http://tinyurl.com/kukz8pt/index_files-do.txt" target="_self"><tt>doc/src/chapters/index_files.do.txt</tt></a>. We refer to the <a href="http://docs.makotemplates.org/en/latest/syntax.html" target="_self">Mako syntax documentation</a> for more information.
</div>


<h2 id="mako:pyscripts">How to automatically generate a DocOnce file with repetitive structure</h2>

<p>
To illustrate how Python and Mako can be used to efficiently
generate repetitive structures with a minimum of manual work,
we consider the following case. Suppose you have a DocOnce document
made up of a number of sections, where the DocOnce source of each section
resides in a subdirectory with name <code>issueX</code>, where <code>X</code> is an integer
counter. You want to create a &quot;master&quot; DocOnce file that includes
all the sections, e.g..

<p>

<!-- code=doconce (!bc do) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #000080; font-weight: bold">======= Issue 1 =======</span>

<span style="color: #408080; font-style: italic"># #include &quot;issue1/issue.do.txt&quot;</span>

<span style="color: #000080; font-weight: bold">======= Issue 2 =======</span>

<span style="color: #408080; font-style: italic"># #include &quot;issue2/issue.do.txt&quot;</span>

<span style="color: #000080; font-weight: bold">======= Issue 3 =======</span>

<span style="color: #408080; font-style: italic"># #include &quot;issue3/issue.do.txt&quot;</span>
</pre></div>
<p>
Maybe issues come and go, and so do the subdirectories, implying that
one should automate the making of the above content of the master
document.

<p>
Generating a set of sections via Mako is easy:

<p>

<!-- code=doconce (!bc do) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">&lt;%
sections = range(1, 8)
%&gt;

% for i in sections:
<span style="color: #000080; font-weight: bold">======= Issue ${i} =======</span>
% endfor
</pre></div>
<p>
Unfortunately, we cannot write

<p>

<!-- code=doconce (!bc do) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">% for i in sections:
<span style="color: #000080; font-weight: bold">======= Issue ${i} =======</span>

<span style="color: #408080; font-style: italic"># #include &quot;issue${i}/issue.do.txt&quot;</span>
% endfor
</pre></div>
<p>
because the <code>#include</code> statement is run by Preprocess <em>prior</em> to
Mako's interpretation of the file.
Instead, we can generate (parts of) the master file in a separate
Python script. This makes it also easier to check which subdirectories
we have and set up the contents of sections based on the file
structure:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000; font-weight: bold">import</span> <span style="color: #0000FF; font-weight: bold">os</span><span style="color: #666666">,</span> <span style="color: #0000FF; font-weight: bold">glob</span>
outfile <span style="color: #666666">=</span> <span style="color: #008000">open</span>(<span style="color: #BA2121">&#39;master_section.do.txt&#39;</span>, <span style="color: #BA2121">&#39;w&#39;</span>)
subdirs <span style="color: #666666">=</span> glob<span style="color: #666666">.</span>glob(<span style="color: #BA2121">&#39;issue*&#39;</span>)
<span style="color: #408080; font-style: italic"># Run through all issue* subdirectory names in sorted sequence</span>
<span style="color: #008000; font-weight: bold">for</span> subdir <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">sorted</span>(subdirs):
    <span style="color: #008000; font-weight: bold">if</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>isdir(subdir):               <span style="color: #408080; font-style: italic"># directory?</span>
        <span style="color: #008000; font-weight: bold">if</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>isfile(<span style="color: #BA2121">&#39;issue.do.txt&#39;</span>):  <span style="color: #408080; font-style: italic"># file?</span>
	    <span style="color: #408080; font-style: italic"># Extract number X from &quot;issueX&quot; name:</span>
	    no <span style="color: #666666">=</span> subdir[<span style="color: #666666">5</span>:]
	    outfile<span style="color: #666666">.</span>write(<span style="color: #BA2121">&quot;&quot;&quot;</span>
<span style="color: #BA2121">======= Issue </span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121"> =======</span>

<span style="color: #BA2121"># #include &quot;</span><span style="color: #BB6688; font-weight: bold">%s</span><span style="color: #BA2121">/issue.do.txt&quot;</span>
<span style="color: #BA2121">&quot;&quot;&quot;</span> <span style="color: #666666">%</span> (no, subdir))
outfile<span style="color: #666666">.</span>close()
</pre></div>
<p>
The master file can now just do an include of <code>master_sections.do.txt</code>.
If the make script for compiling DocOnce to various formats first
runs the script above, the <code>master_sections.do.txt</code> contents are
up-to-date with the current file structure, and the contents
automatically propagate to the master document.

<p>
There is one potential problem in the above example: the <code>issue.do.txt</code>
files may include figures with local paths. For example,
<code>issue5/issue.do.txt</code> contains

<p>

<!-- code=doconce (!bc do) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%"><span style="color: #008000">FIGURE: [fig/myfig, width=500 frac=0.8] My figure. label{my:fig}</span>
</pre></div>
<p>
When compiling the master document, no <code>fig/myfig.png</code> is found because
the correct path, relative to the master document's directory,
is <code>issue5/fig/myfig.png</code>. The same problem arises if there are
source code inclusion statements like <code>@@@CODE src/myprog.f</code>.
The master document would then need <code>@@@CODE issue5/src/myprog.f</code>.
The best way out of these problems is

<ol>
<li> Let figure and source code directories have a unique name,
   say <code>fig5</code> and <code>src5</code> in this example.</li>
<li> Create links from the master document's directory to
   all the <code>fig*</code> and <code>src*</code> subdirectories.</li>
</ol>

Point 2 can be automated:

<p>

<!-- code=python (!bc pycod) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">subdirs <span style="color: #666666">=</span> glob<span style="color: #666666">.</span>glob(<span style="color: #BA2121">&#39;issue*&#39;</span>)
<span style="color: #008000; font-weight: bold">for</span> subdir <span style="color: #AA22FF; font-weight: bold">in</span> <span style="color: #008000">sorted</span>(subdirs):
    <span style="color: #008000; font-weight: bold">if</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>isdir(subdir):
        no <span style="color: #666666">=</span> subdir[<span style="color: #666666">5</span>:]
        figdir <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;fig&#39;</span> <span style="color: #666666">+</span> no
        srcdir <span style="color: #666666">=</span> <span style="color: #BA2121">&#39;src&#39;</span> <span style="color: #666666">+</span> no
	<span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>islink(figdir):
	   path <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>join(subdir, figdir)
	       os<span style="color: #666666">.</span>symlink(figdir, path)
	<span style="color: #008000; font-weight: bold">if</span> <span style="color: #AA22FF; font-weight: bold">not</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>islink(srcdir):
	   path <span style="color: #666666">=</span> os<span style="color: #666666">.</span>path<span style="color: #666666">.</span>join(subdir, srcdir)
	       os<span style="color: #666666">.</span>symlink(figdir, path)
</pre></div>
<p>
This little case study shows the power of using scripts
to assist the writing process.

<h2 id="___sec6">How to treat multiple programming languages in the same text </h2>

<p>
With these ideas, it becomes straightforward to write a book that
has its program examples in multiple languages. Introduce <code>CODE</code>
as the name of the language and use if tests for larger portions
of code and text, and Mako functions for shorter inline texts,
to handle text that depends on the value of <code>CODE</code>.
The author has successfully co-written such a <a href="http://hplgit.github.io/Programming-for-Computations/pub/p4c/index.html" target="_self">book</a>
<a href="#Linge_Langtangen_2015">[1]</a>
for mathematical programming with either Python or Matlab - the version
is set when running <code>doconce format</code>.

<p>
Here is an example of text, in the style of the mention book,
where there are small differences
depending on the programming language:

<p>

<!-- code=doconce (!bc do) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">The following ${CODE} function `sampler` does the job
(see the file &quot;${src(&#39;sampler&#39;)}&quot;:
<span style="color: #BA2121">&quot;https://github.com/myuser/myproject/src/${src(&#39;sampler&#39;)}&quot;</span>):

${copyfile(&#39;sampler&#39;)}

Note that in ${CODE}, arrays start at index ${text2(&#39;0&#39;, &#39;1&#39;)}.
Array slices like ${verb2(&#39;vec[2:8]&#39;, &#39;vec(2:7)&#39;)}
go from the first index (here `2`) up to
${text2(&#39;*but not including* the upper limit (here `8`)&#39;,
&#39;(including) the upper limit (here `7`)&#39;}.
% if CODE == &#39;Python&#39;:
Also note that the file `sampler.py` is a module, meaning
that we can call all the file&#39;s functions from other programs,
including `sampler_vec`.
% elif CODE == &#39;Matlab&#39;:
Also note that only the `sampler` function can be called
from other Matlab programs. If we want the alternative
implementation in function `sampler_vec` to be reused
by other programs, this function has to reside in a file
<span style="color: #BA2121">`sampler_vec.py`</span>.
% endif
</pre></div>
<p>
Here we have made use of a few Mako functions to easily
choose between a Python or Matlab relevant text:

<ul>
 <li> <code>src</code> for picking a filename with the right extension (<code>.py</code> or <code>.m</code>)</li>
 <li> <code>copyfile</code> for constructing the right <code>@@@CODE</code> line for a Python or
   Matlab source code file</li>
 <li> <code>text2</code> for picking the first (Python) or second (Matlab) argument</li>
 <li> <code>verb2</code> for picking the first (Python) or second (Matlab) argument typeset in
   inline verbatim font</li>
</ul>

The exact Mako code appears below.

<p>

<!-- code=doconce (!bc do) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">&lt;%
def src(filestem, url=None, verb=True):
    &quot;&quot;&quot;Return filstem plus .m or .py.&quot;&quot;&quot;
    if CODE == &quot;Python&quot;:
        filename = filestem + &#39;.py&#39;
    else:
        filename = filestem + &#39;.m&#39;
    if verb:
        filename = &#39;`%s`&#39; % filename
    if url is not None:
        # Make link to the file at github
        pass
    return filename

def copyfile(filestem, from_=None, to_=None):
    &quot;&quot;&quot;Return @@@CODE line for copying a Python/Matlab file.&quot;&quot;&quot;
    r = &quot;@@@CODE &quot;
    if CODE == &quot;Python&quot;:
        r += &quot;py-src/&quot; + filestem + &#39;.py&#39;
    else:
        r += &quot;m-src/&quot; + filestem + &#39;.m&#39;
    if from_ is not None:
        r += &#39; fromto: &#39; + from_ + &#39;@&#39;
    if to_ is not None:
        r += to_
    return r

def verb2(py_expr, m_expr):
    &quot;&quot;&quot;Return py_expr or m_expr in verbatim depending on CODE.&quot;&quot;&quot;
    if CODE == &quot;Python&quot;:
        expr = py_expr
    else:
        expr = m_expr
    expr = &#39;`%s`&#39; % expr
    return expr

def text2(py_expr, m_expr):
    &quot;&quot;&quot;Return py_expr or m_expr depending on CODE.&quot;&quot;&quot;
    if CODE == &quot;Python&quot;:
        expr = py_expr
    else:
        expr = m_expr
    return expr

%&gt;
</pre></div>
<p>
Compiling the document with

<p>

<!-- code=text (!bc sys) typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">Terminal&gt; doconce format plain mydoc CODE=Python \
          --latex_code_style=pyg
</pre></div>
<p>
results in the output

<p>

<!-- code=text typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">The following Python function \Verb!sampler! does the job
(see the file
\href{{https://github.com/myuser/myproject/src/`sampler.py`}}{
\nolinkurl{sampler.py}}):

\begin{minted}[fontsize=\fontsize{9pt}{9pt},linenos=false,
baselinestretch=1.0,fontfamily=tt,xleftmargin=2mm]{python}
&quot;&quot;&quot;Sampler module.&quot;&quot;&quot;

def sampler(...):
    ...
\end{minted}

Note that in Python, arrays start at index 0.
Array slices like \Verb!vec[2:8]!
go from the first index (here \Verb!2!) up to
\emph{but not including} the upper limit (here \Verb!8!).
Also note that the file \Verb!sampler.py! is a module, meaning
that we can call all the file&#39;s functions from other programs,
including \Verb!sampler_vec!.
</pre></div>
<p>
Switching to <code>CODE=Matlab</code> gives

<p>

<!-- code=text typeset with pygments style "default" -->
<div class="highlight" style="background: #f8f8f8"><pre style="line-height: 125%">The following Matlab function \Verb!sampler! does the job
(see the file
\href{{https://github.com/myuser/myproject/src/`sampler.m`}}{
\nolinkurl{sampler.m}}):

\begin{minted}[fontsize=\fontsize{9pt}{9pt},linenos=false,
baselinestretch=1.0,fontfamily=tt,xleftmargin=2mm]{matlab}
% Sampler code

function samples = sampler(...):
    ...
\end{minted}

Note that in Matlab, arrays start at index 1.
Array slices like \Verb!vec(2:7)!
go from the first index (here \Verb!2!) up to
(including) the upper limit (here \Verb!7!.
Also note that only the \Verb!sampler! function can be called
from other Matlab programs. If we want the alternative
implementation in function \Verb!sampler_vec! to be reused
by other programs, this function has to reside in a file
\Verb!sampler_vec.py!.
</pre></div>

<h3 id="___sec7">Another example </h3>

<p>
The manual contains a useful <a href="http://hplgit.github.io/doconce/doc/pub/manual/._manual024.html#manual:mako:nomenclature" target="_self">example</a>
on how to use Mako to implement
the nomenclature functionality in the LaTeX package <code>nomencl</code>.

<h1 id="___sec8">References </h1>

<p>
<!-- begin bibliography -->

<ol>
 <li> <div id="Linge_Langtangen_2015"></div> <b>S. Linge and H. P. Langtangen</b>. 
    <em>Programming for Computations</em>,
    2015,
    <a href="http://hplgit.github.io/Programming-for-Computations/pub/p4c/" target="_self"><tt>http://hplgit.github.io/Programming-for-Computations/pub/p4c/</tt></a>.</li>
</ol>

<!-- end bibliography -->

<p>
<!-- navigation buttons at the bottom of the page -->
<ul class="pager">
  <li class="previous">
    <a href="._mako-bootstrap002.html">&larr; Prev</a>
  </li>
</ul>
<!-- ------------------- end of main content --------------- -->

</div>  <!-- end container -->
<!-- include javascript, jQuery *first* -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>

<!-- Bootstrap footer
<footer>
<a href="http://..."><img width="250" align=right src="http://..."></a>
</footer>
-->


</body>
</html>
    

